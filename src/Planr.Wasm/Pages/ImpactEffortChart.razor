@page "/impact-effort"
@using Planr.Core.Models.ImpactEffort
@using Planr.Core.Models
@using Planr.Core.Renderers
@using System.Text.Json
@inject IJSRuntime JS

<PageTitle>Impact-Effort Matrix</PageTitle>

<div class="container mt-4">
    <h1>Impact-Effort Matrix</h1>
    <p class="lead">Analyze tasks by their impact and effort to prioritize work</p>

    <div class="row">
        <div class="col-md-12">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <button class="btn btn-link text-decoration-none text-dark p-0 fw-bold" type="button" @onclick="ToggleTaskEditor">
                            Task Editor <span style="font-size: 0.8em">@(ShowTaskEditor ? "▼" : "▶")</span>
                        </button>
                    </h5>
                    <div class="d-flex align-items-center">
                        <div class="me-2">
                             <InputFile OnChange="LoadFile" class="form-control form-control-sm" accept=".json" />
                        </div>

                        <button type="button" class="btn btn-primary btn-sm me-2" @onclick="AddTask">+ Add Task</button>
                    </div>
                </div>
                <div class="@(ShowTaskEditor ? "collapse show" : "collapse")">
                    <div class="card-body p-0">
                        <table class="table table-striped table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Ref</th>
                                    <th>Name</th>
                                    <th>Category</th>
                                    <th>Impact</th>
                                    <th>Effort</th>
                                    <th style="width: 100px;">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var task in Spec.Tasks)
                                {
                                    <tr>
                                        <td><input type="text" class="form-control form-control-sm" @bind="task.Ref" placeholder="REF" maxlength="2" style="text-transform: uppercase; font-weight: bold;"></td>
                                        <td><input type="text" class="form-control form-control-sm" @bind="task.Name" placeholder="Task Name"></td>
                                        <td><input type="text" class="form-control form-control-sm" @bind="task.Category" placeholder="Category"></td>
                                        <td>
                                            <select class="form-select form-select-sm" @bind="task.Impact">
                                                @foreach (var impact in Enum.GetValues<ImpactLevel>())
                                                {
                                                    <option value="@impact">@impact</option>
                                                }
                                            </select>
                                        </td>
                                        <td>
                                            <select class="form-select form-select-sm" @bind="task.Effort">
                                                @foreach (var effort in Enum.GetValues<EffortLevel>())
                                                {
                                                    <option value="@effort">@effort</option>
                                                }
                                            </select>
                                        </td>
                                        <td><button type="button" class="btn btn-outline-danger btn-sm" @onclick="() => RemoveTask(task)">Remove</button></td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <button class="btn btn-link text-decoration-none text-dark p-0 fw-bold" type="button" @onclick="ToggleChartSettings">
                            Chart Settings <span style="font-size: 0.8em">@(ShowChartSettings ? "▼" : "▶")</span>
                        </button>
                    </h5>
                </div>
                <div class="@(ShowChartSettings ? "collapse show" : "collapse")">
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label small fw-bold">Chart Title</label>
                                <input type="text" class="form-control form-control-sm" @bind="Spec.Config.Title" placeholder="e.g. Project Prioritization">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label small fw-bold">Container Max Width</label>
                                <select class="form-select form-select-sm" @bind="Spec.Config.ContainerMaxWidth">
                                    @foreach (var width in Enum.GetValues<ScreenWidth>())
                                    {
                                        <option value="@width">@GetScreenWidthLabel(width)</option>
                                    }
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    @if (!string.IsNullOrEmpty(ErrorMessage))
    {
        <div class="alert alert-danger">@ErrorMessage</div>
    }

    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Chart Preview</h5>
            <div class="d-flex align-items-center">
              <button type="button" class="btn btn-outline-secondary btn-sm me-2" @onclick="ExportJson">Export JSON</button>
              <button type="button" class="btn btn-success btn-sm" @onclick="GenerateChart">Generate Chart</button>
            </div>
        </div>
        <div class="card-body overflow-auto @(string.IsNullOrEmpty(ChartHtml) ? "collapse" : "collapse show")">
            @if (!string.IsNullOrEmpty(ChartHtml))
            {
                @((MarkupString)ChartHtml)
            }
        </div>
    </div>
</div>

@code {
    private ImpactEffortSpec Spec { get; set; } = new();
    private string? ChartHtml { get; set; }
    private string? ErrorMessage { get; set; }
    private bool ShowTaskEditor { get; set; } = true;
    private bool ShowChartSettings { get; set; } = false;

    protected override void OnInitialized()
    {
        // Default data
        Spec.Tasks = new List<ImpactEffortTask>
        {
            new()
            {
                Ref = "01",
                Name = "User Authentication",
                Category = "Security",
                Impact = ImpactLevel.High,
                Effort = EffortLevel.Medium,
            },
            new()
            {
                Ref = "02", 
                Name = "Password Reset Feature",
                Category = "Security",
                Impact = ImpactLevel.High,
                Effort = EffortLevel.Low,
            },
            new()
            {
                Ref = "03",
                Name = "Bug Fixes",
                Category = "Maintenance",
                Impact = ImpactLevel.Medium,
                Effort = EffortLevel.Low,
            },
            new()
            {
                Ref = "04",
                Name = "API Documentation",
                Category = "Documentation",
                Impact = ImpactLevel.Medium,
                Effort = EffortLevel.High,
            }
        };
    }

    private void ToggleTaskEditor()
    {
        ShowTaskEditor = !ShowTaskEditor;
    }

    private void ToggleChartSettings()
    {
        ShowChartSettings = !ShowChartSettings;
    }

    private string GetScreenWidthLabel(ScreenWidth width) => width switch
    {
        ScreenWidth.Narrow => "Narrow (800px)",
        ScreenWidth.Standard => "Standard (1000px)",
        ScreenWidth.Wide => "Wide (1200px)",
        ScreenWidth.ExtraWide => "Extra Wide (1400px)",
        ScreenWidth.Fluid => "Fluid (100%)",
        _ => width.ToString()
    };

    private void AddTask()
    {
        var nextNumber = (Spec.Tasks.Count + 1) % 100; // Cycle through 00-99
        Spec.Tasks.Add(new ImpactEffortTask
        {
            Ref = $"{nextNumber:D2}",
            Name = "New Task",
            Category = "General",
            Impact = ImpactLevel.Medium,
            Effort = EffortLevel.Medium
        });
    }

    private void RemoveTask(ImpactEffortTask task)
    {
        Spec.Tasks.Remove(task);
    }

    private async Task LoadFile(InputFileChangeEventArgs e)
    {
        ErrorMessage = null;
        try
        {
            var file = e.File;
            if (file != null)
            {
                using var stream = file.OpenReadStream();
                var spec = await JsonSerializer.DeserializeAsync<ImpactEffortSpec>(stream, new JsonSerializerOptions { PropertyNameCaseInsensitive = true });
                if (spec != null)
                {
                    // Validate and format all references to be exactly 2 characters
                    foreach (var task in spec.Tasks)
                    {
                        if (string.IsNullOrEmpty(task.Ref))
                            task.Ref = "00";
                        else if (task.Ref.Length > 2)
                            task.Ref = task.Ref.Substring(0, 2).ToUpper();
                        else if (task.Ref.Length < 2)
                            task.Ref = task.Ref.PadRight(2, '0').ToUpper();
                        else
                            task.Ref = task.Ref.ToUpper();
                    }
                    
                    Spec = spec;
                    if (Spec.Tasks == null) Spec.Tasks = new List<ImpactEffortTask>();
                    GenerateChart();
                }
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error parsing imported JSON: {ex.Message}";
        }
    }

    private async Task ExportJson()
    {
        var options = new JsonSerializerOptions { PropertyNameCaseInsensitive = true, WriteIndented = true, PropertyNamingPolicy = JsonNamingPolicy.CamelCase };
        var json = JsonSerializer.Serialize(Spec, options);
        await JS.InvokeVoidAsync("downloadFile", "impact-effort-spec.json", json);
    }

    private void GenerateChart()
    {
        ErrorMessage = null;
        try
        {
            ChartHtml = HtmlImpactEffortRenderer.Render(Spec, partial: true);
        }
        catch (Exception ex)
        {
             ErrorMessage = $"Error generating chart: {ex.Message}";
        }
        ShowTaskEditor = false;
    }
}
