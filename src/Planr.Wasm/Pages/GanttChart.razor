@page "/"
@using Planr.Core.Configuration
@using Planr.Core.Models
@using Planr.Core.Models.Gantt
@using Microsoft.JSInterop
@using System.Text.Json
@inject IJSRuntime JSRuntime
@inherits ChartPageBase<GanttSpec>

<PageTitle>Gantt Chart</PageTitle>

<div class="container mt-4">
    <h1>@ChartTitle</h1>
    <p class="lead">@ChartDescription</p>

    <div class="row">
        <div class="col-md-12">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <button class="btn btn-link text-decoration-none text-dark p-0 fw-bold" type="button" @onclick="ToggleItemEditor">
                            Task Editor <span style="font-size: 0.8em">@(ShowItemEditor ? "▼" : "▶")</span>
                        </button>
                    </h5>
                    <div class="d-flex align-items-center">
                        <div class="me-2">
                             <InputFile OnChange="(e) => LoadFile(e)" class="form-control form-control-sm" accept=".json" />
                        </div>

                        <button type="button" class="btn btn-primary btn-sm me-2" @onclick="AddTask">+ Add Task</button>
                    </div>
                </div>
                <div class="@(ShowItemEditor ? "collapse show" : "collapse")">
                    <div class="card-body p-0">
                        <table class="table table-striped table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Project</th>
                                    <th>Task Name</th>
                                    <th>Start Date</th>
                                    <th>End Date</th>
                                    <th>Priority</th>
                                    <th style="width: 100px;">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var task in Spec.Tasks)
                                {
                                    <tr>
                                        <td><input type="text" class="form-control form-control-sm" @bind="task.Project" placeholder="Project Name"></td>
                                        <td><input type="text" class="form-control form-control-sm" @bind="task.Name" placeholder="Task Name"></td>
                                        <td><input type="date" class="form-control form-control-sm" @bind="task.Start" ></td>
                                        <td><input type="date" class="form-control form-control-sm" @bind="task.End" ></td>
                                        <td>
                                            <select class="form-select form-select-sm" @bind="task.Priority">
                                                @foreach (var p in Enum.GetValues<GanttPriority>())
                                                {
                                                    <option value="@p">@p</option>
                                                }
                                            </select>
                                        </td>
                                        <td><button type="button" class="btn btn-outline-danger btn-sm" @onclick="() => RemoveTask(task)">Remove</button></td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <button class="btn btn-link text-decoration-none text-dark p-0 fw-bold" type="button" @onclick="ToggleChartSettings">
                            Chart Settings <span style="font-size: 0.8em">@(ShowChartSettings ? "▼" : "▶")</span>
                        </button>
                    </h5>
                </div>
                <div class="@(ShowChartSettings ? "collapse show" : "collapse")">
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label small fw-bold">Chart Title</label>
                                <input type="text" class="form-control form-control-sm" @bind="Spec.Config.Title" placeholder="e.g. Project Roadmap">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label small fw-bold">Label Width (px)</label>
                                <input type="number" class="form-control form-control-sm" @bind="Spec.Config.LabelWidth" min="50" max="500" step="10">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label small fw-bold">Container Max Width</label>
                                <select class="form-select form-select-sm" @bind="Spec.Config.ContainerMaxWidth">
                                    @foreach (var width in Enum.GetValues<Screen.Width>())
                                    {
                                        <option value="@width">@GetScreenWidthLabel(width)</option>
                                    }
                                </select>
                            </div>
                            <div class="col-md-3 d-flex align-items-end">
                                <div class="form-check mb-1">
                                    <input class="form-check-input" type="checkbox" id="showLegendCheck" @bind="Spec.Config.ShowLegend">
                                    <label class="form-check-label small" for="showLegendCheck">
                                        Show Legend
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    @if (!string.IsNullOrEmpty(ErrorMessage))
    {
        <div class="alert alert-danger">@ErrorMessage</div>
    }

    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Chart Preview</h5>
            <div class="d-flex align-items-center">
              <button type="button" class="btn btn-outline-secondary btn-sm me-2" @onclick="ExportJson">Export JSON</button>
              <button type="button" class="btn btn-success btn-sm" @onclick="GenerateChart">Generate Chart</button>
            </div>
        </div>
        <div class="card-body overflow-auto @(string.IsNullOrEmpty(ChartHtml) ? "collapse" : "collapse show")">
            @if (!string.IsNullOrEmpty(ChartHtml))
            {
                @((MarkupString)ChartHtml)
            }
        </div>
    </div>
</div>

@code {
    protected override string ChartTitle => "Gantt Chart";
    protected override string ChartDescription => "Add your project tasks and customise a Gantt chart";
    protected override string ExportFileName => "planr-spec.json";

    protected override Func<Task> GenerateChartAsync => () => Task.Run(() =>
    {
        ChartHtml = Renderer.Render(Spec, partial: true);
    });

    protected override void InitializeDefaultData()
    {
        Spec = new GanttSpec
        {
            Tasks = new List<GanttTask>
            {
                new()
                {
                    Project = "Project Alpha",
                    Name = "Planning",
                    Start = DateTime.Today,
                    End = DateTime.Today.AddDays(14),
                    Priority = GanttPriority.Critical,
                },
                new()
                {
                    Project = "Project Alpha",
                    Name = "Execution",
                    Start = DateTime.Today.AddDays(14),
                    End = DateTime.Today.AddDays(28),
                    Priority = GanttPriority.High,
                },
            }
        };
    }

    private void AddTask()
    {
        Spec.Tasks.Add(new GanttTask
        {
            Project = "New Project",
            Name = "New Task",
            Start = DateTime.Today,
            End = DateTime.Today.AddDays(7),
            Priority = GanttPriority.Medium
        });
    }

    private void RemoveTask(GanttTask task)
    {
        Spec.Tasks.Remove(task);
    }

    protected override void OnFileLoaded()
    {
        if (Spec.Tasks == null)
            Spec.Tasks = new List<GanttTask>();
    }

    private async Task ExportJson()
    {
        var json = JsonSerializer.Serialize(Spec, GetOptions());
        await JSRuntime.InvokeVoidAsync("downloadFile", ExportFileName, json);
    }
}
